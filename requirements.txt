import streamlit as st
from datetime import datetime
import json, io

# ---------------------------------
# Page Setup
# ---------------------------------
st.set_page_config(
    page_title="ğŸ“ Study Style Wizard",
    page_icon="ğŸ“˜",
    layout="wide",
)

CSS = """
<style>
.huge{font-size:clamp(32px,6vw,66px);font-weight:900;letter-spacing:.3px;
  background:linear-gradient(90deg,#0ea5e9,#a855f7,#f59e0b);
  -webkit-background-clip:text;background-clip:text;color:transparent;}
.card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);
  border-radius:18px;padding:16px 18px;box-shadow:0 10px 26px rgba(0,0,0,.18)}
.pill{display:inline-flex;gap:8px;align-items:center;padding:6px 12px;border-radius:999px;
  background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);margin:6px 6px 0 0}
.small{font-size:13px;opacity:.82}
.block-container{padding-top:1rem}
hr{border:none;height:1px;background:linear-gradient(90deg,transparent,#ffffff33,transparent);margin:8px 0}
</style>
"""

st.markdown(CSS, unsafe_allow_html=True)

# ---------------------------------
# Helpers
# ---------------------------------

def pill(txt: str) -> str:
    return f"<span class='pill'>{txt}</span>"

METHODS = {
    "Pomodoro â±ï¸": {
        "desc": "25ë¶„ ì§‘ì¤‘ + 5ë¶„ íœ´ì‹, ì§§ì€ ìŠ¤í”„ë¦°íŠ¸ë¡œ ëª°ì…ë„ ìœ ì§€",
        "when": "ì‹œê°„ì´ ìª¼ê°œì§€ê³  ì‚°ë§Œí•  ë•Œ",
        "how": ["íƒ€ì´ë¨¸ ì¼œê¸° (25/5)", "4íšŒ ë°˜ë³µ í›„ 15~20ë¶„ ê¸´ íœ´ì‹", "ì•Œë¦¼ ì°¨ë‹¨ ëª¨ë“œ"],
    },
    "Deep Work ğŸ§ ": {
        "desc": "ë°©í•´ ìš”ì†Œë¥¼ ì œê±°í•˜ê³  60~90ë¶„ ê¹Šê²Œ ëª°ì…",
        "when": "ë‚œë„ ë†’ì€ ê³¼ì œÂ·ë¬¸ì œ í’€ì´",
        "how": ["í°â†“, íƒ­ ìµœì†Œí™”", "ë¬¸ì„œ/ë¬¸ì œ 1ê°œë§Œ", "ëë‚˜ê³  íšŒê³  3ì¤„"],
    },
    "Spaced Repetition ğŸ”": {
        "desc": "ê°„ê²© ë‘ê³  ë°˜ë³µ ë³µìŠµìœ¼ë¡œ ì¥ê¸°ê¸°ì–µ ê°•í™”",
        "when": "ì•”ê¸° ê³¼ëª©, ê°œë… ë°˜ë³µ",
        "how": ["1ì¼Â·3ì¼Â·7ì¼Â·14ì¼ ë³µìŠµ", "ì§§ê²Œ ìì£¼", "ì˜¤ë‹µ/í—·ê°ˆë¦¼ íƒœê¹…"],
    },
    "Active Recall â“": {
        "desc": "ì±… ë®ê³  ìŠ¤ìŠ¤ë¡œ ë– ì˜¬ë¦¬ê¸°/ì„¤ëª…í•˜ê¸°",
        "when": "ê°œë… í™•ì¸, ì‹œí—˜ ëŒ€ë¹„",
        "how": ["í‚¤ì›Œë“œë§Œ ë³´ê³  ë§/ì“°ê¸°", "ìŠ¤ìŠ¤ë¡œ í€´ì¦ˆ ë§Œë“¤ê¸°", "ì •ë‹µ ë§ì¶˜ ë’¤ ê·¼ê±° í™•ì¸"],
    },
    "Interleaving ğŸ”€": {
        "desc": "ìœ ì‚¬ ê³¼ëª©/ìœ í˜•ì„ ì„ì–´ í•™ìŠµ ì „ì´ ì´‰ì§„",
        "when": "ë¬¸ì œí’€ì´ ìŠ¤í‚¬ í–¥ìƒ",
        "how": ["ë‹¨ì› Aâ†’Bâ†’Aâ†’Cë¡œ êµì°¨", "ì‰¬ìš´/ì–´ë ¤ìš´ ë‚œë„ ì„ê¸°", "íŒ¨í„´ ë¹„êµ ë©”ëª¨"],
    },
    "Feynman âœï¸": {
        "desc": "ëˆ„êµ°ê°€ì—ê²Œ ê°€ë¥´ì¹˜ë“¯ ê°„ë‹¨í•œ ì–¸ì–´ë¡œ ì„¤ëª…",
        "when": "ê¹Šì€ ì´í•´ í•„ìš”",
        "how": ["A4 1ì¥ì— ì‰¬ìš´ ë§ë¡œ ì„¤ëª…", "ë¹„ìœ  ë§Œë“¤ê¸°", "ëª¨ë¥´ëŠ” ë¶€ë¶„ í‘œì‹œ í›„ ë‹¤ì‹œ í•™ìŠµ"],
    },
}

# ì ìˆ˜ ê°€ì¤‘ì¹˜ ê·œì¹™ (ê°„ë‹¨, í•´ì„ ê°€ëŠ¥)
RULES = [
    # (condition, {method: score_delta})
    (lambda a: a["time_block"] <= 35, {"Pomodoro â±ï¸": 12}),
    (lambda a: a["time_block"] >= 60, {"Deep Work ğŸ§ ": 14}),
    (lambda a: a["noise"] >= 70, {"Pomodoro â±ï¸": 6, "Deep Work ğŸ§ ": 8}),
    (lambda a: a["exam_near"], {"Active Recall â“": 10, "Spaced Repetition ğŸ”": 8}),
    (lambda a: a["memory_heavy"] >= 60, {"Spaced Repetition ğŸ”": 12, "Active Recall â“": 6}),
    (lambda a: a["concept_heavy"] >= 60, {"Feynman âœï¸": 12, "Deep Work ğŸ§ ": 6}),
    (lambda a: a["mix_like"] >= 60, {"Interleaving ğŸ”€": 12}),
    (lambda a: a["night_owl"] >= 60, {"Deep Work ğŸ§ ": 5}),
]

BASE = {k: 50 for k in METHODS.keys()}

# ---------------------------------
# Header
# ---------------------------------
left, right = st.columns([0.72, 0.28])
with left:
    st.markdown("<div class='huge'>Study Style Wizard ğŸ“˜âœ¨</div>", unsafe_allow_html=True)
    st.markdown("**ê³µë¶€ ì„±í–¥** ëª‡ ê°€ì§€ë¥¼ ì„ íƒí•˜ë©´, ë‚˜ì—ê²Œ ë§ëŠ” **ê³µë¶€ë²• TOP 3**ë¥¼ ì¶”ì²œí•´ì¤˜ìš”! ğŸŒˆğŸ§‘â€ğŸ“")
with right:
    st.metric("Today", datetime.now().strftime("%Y-%m-%d"))

st.write("")

# ---------------------------------
# Sidebar â€“ Inputs
# ---------------------------------
with st.sidebar:
    st.markdown("## ğŸ›ï¸ ì„¤ì •")
    st.markdown("í•™ìŠµ í™˜ê²½ê³¼ ëª©í‘œë¥¼ ì•Œë ¤ì£¼ì„¸ìš” âœï¸")
    time_block = st.slider("í•œ ë²ˆì— ì§‘ì¤‘ ê°€ëŠ¥í•œ ì‹œê°„(ë¶„) â±ï¸", 10, 120, 35, step=5)
    noise = st.slider("ì‚°ë§Œí•¨ ì •ë„(ì•Œë¦¼/ì¡ìƒê°) ğŸ“±", 0, 100, 60)
    memory_heavy = st.slider("ì•”ê¸° ë¹„ì¤‘(ë‹¨ì–´/ìš©ì–´ ë“±) ğŸ§ ", 0, 100, 50)
    concept_heavy = st.slider("ê°œë… ì´í•´ ë¹„ì¤‘(ì´ë¡ /ì¦ëª… ë“±) ğŸ“š", 0, 100, 50)
    mix_like = st.slider("ë¬¸ì œ ìœ í˜• ì„ì–´ í’€ê¸° ì„ í˜¸ë„ ğŸ”€", 0, 100, 40)
    night_owl = st.slider("ì €ë…í˜•(ì•¼í–‰ì„±) ì„±í–¥ ğŸŒ™", 0, 100, 40)
    exam_near = st.checkbox("ì‹œí—˜ì´ ì¼ì£¼ì¼ ì´ë‚´ì˜ˆìš” ğŸ“†", value=False)

    st.markdown("---")
    run = st.button("âœ¨ ë‚´ ê³µë¶€ë²• ì¶”ì²œë°›ê¸°")

answers = {
    "time_block": time_block,
    "noise": noise,
    "memory_heavy": memory_heavy,
    "concept_heavy": concept_heavy,
    "mix_like": mix_like,
    "night_owl": night_owl,
    "exam_near": exam_near,
}

# ---------------------------------
# Compute Recommendation
# ---------------------------------
score = BASE.copy()
for cond, updates in RULES:
    try:
        if cond(answers):
            for k, v in updates.items():
                score[k] += v
    except Exception:
        pass

ranking = sorted(score.items(), key=lambda x: x[1], reverse=True)

# ---------------------------------
# Output
# ---------------------------------
st.markdown("### ğŸŒŸ ì¶”ì²œ ê³µë¶€ë²• TOP 3")
cols = st.columns(3)
for i, (name, sc) in enumerate(ranking[:3]):
    with cols[i]:
        st.markdown("<div class='card'>", unsafe_allow_html=True)
        st.markdown(f"#### {name}")
        st.markdown(f"<div class='small'>ì í•©ë„ ì ìˆ˜ â­ {round(sc,1)}</div>", unsafe_allow_html=True)
        st.markdown("<hr>")
        st.markdown(f"{pill('ìš”ì•½')} {METHODS[name]['desc']}", unsafe_allow_html=True)
        st.markdown(f"{pill('ì–¸ì œ ì¢‹ì„ê¹Œ')} {METHODS[name]['when']}", unsafe_allow_html=True)
        st.markdown("**ì‹¤í–‰ íŒ**")
        st.markdown("\n".join([f"- {tip}" for tip in METHODS[name]["how"]]))
        st.markdown("</div>", unsafe_allow_html=True)

# Personalized plan block
st.markdown("### ğŸ—“ï¸ 7ì¼ ì•¡ì…˜ í”Œëœ")
plan_col1, plan_col2 = st.columns([0.6, 0.4])
sel1, sel2, sel3 = [k for k,_ in ranking[:3]]
with plan_col1:
    st.markdown("<div class='card'>", unsafe_allow_html=True)
    st.markdown("**í•µì‹¬ ë£¨í‹´**")
    st.markdown(
        f"- {pill(sel1)} 30~90ë¶„ í•µì‹¬ ì„¸ì…˜ 1íšŒ\n\n"+
        f"- {pill(sel2)} ì§§ì€ ì„¸ì…˜ 2íšŒ\n\n"+
        f"- {pill(sel3)} ê³¼ëª©/ìœ í˜• êµì°¨ 20~30ë¶„", unsafe_allow_html=True)
    st.markdown("**ì¼ì¼ ì²´í¬ë¦¬ìŠ¤íŠ¸**")
    st.markdown("- ë°©í•´ìš”ì†Œ ì°¨ë‹¨(ì•Œë¦¼ OFF)\n- ì„¸ì…˜ í›„ 3ì¤„ íšŒê³ \n- ì˜¤ë‹µ/í—·ê°ˆë¦° ê°œë… íƒœê¹…")
    st.markdown("</div>", unsafe_allow_html=True)

with plan_col2:
    st.markdown("<div class='card'>", unsafe_allow_html=True)
    st.markdown("**ì˜¤ëŠ˜ì˜ í™˜ê²½ ìš”ì•½**")
    st.markdown(
        " ".join(
            pill(t) for t in [
                f"â±ï¸ {time_block}m", f"ğŸ“±ì‚°ë§Œí•¨ {noise}", f"ğŸ§ ì•”ê¸° {memory_heavy}",
                f"ğŸ“šê°œë… {concept_heavy}", f"ğŸ”€êµì°¨ {mix_like}", f"ğŸŒ™ì•¼í–‰ {night_owl}",
                ("ğŸ“†ì‹œí—˜ ì„ë°•" if exam_near else "ì—¬ìœ  ìˆìŒ ğŸ§˜")
            ]
        ),
        unsafe_allow_html=True,
    )
    st.markdown("</div>", unsafe_allow_html=True)

# Celebrations & Export
if run:
    st.balloons()

snapshot = {
    "timestamp": datetime.now().isoformat(timespec="seconds"),
    "answers": answers,
    "top3": [{"method": k, "score": round(v,1)} for k, v in ranking[:3]],
    "plan": {
        "routine": [sel1, sel2, sel3],
        "checklist": ["ì•Œë¦¼ OFF", "ì„¸ì…˜ í›„ 3ì¤„ íšŒê³ ", "ì˜¤ë‹µ íƒœê¹…"],
    },
}

buf = io.BytesIO(json.dumps(snapshot, ensure_ascii=False, indent=2).encode("utf-8"))
st.download_button(
    "ğŸ“¥ ë‚´ ë§ì¶¤ ê²°ê³¼ JSON ë‹¤ìš´ë¡œë“œ",
    data=buf.getvalue(),
    file_name="study_style_result.json",
    mime="application/json",
)

st.markdown(
    "<div class='small'>âš ï¸ ì°¸ê³ : ê³µë¶€ë²•ì€ ë„êµ¬ì¼ ë¿, ìƒí™©ê³¼ ê³¼ëª©ì— ë§ê²Œ ìœ ì—°í•˜ê²Œ ì¡°í•©í•´ë³´ì„¸ìš”. ê¾¸ì¤€í•¨ì´ ì™•ê´€ì…ë‹ˆë‹¤ ğŸ‘‘</div>",
    unsafe_allow_html=True,
)

